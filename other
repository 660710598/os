‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üôå ‡∏ú‡∏°‡∏à‡∏∞‡∏ß‡∏≤‡∏î **diagram ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô `RandomAccessFile ‚Üí FileChannel ‚Üí MappedByteBuffer ‚Üí Shared Slots`** ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û

---

## üîπ Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

```
 Process 1              Process 2              Process 3
    |                      |                      |
    |                      |                      |
RandomAccessFile       RandomAccessFile       RandomAccessFile
   ("rw")                 ("rw")                 ("rw")
    |                      |                      |
    | getChannel()         | getChannel()         | getChannel()
    v                      v                      v
  FileChannel  --------- Shared File ---------  FileChannel
 ("heartbeat_shared.dat")  (disk)          ("heartbeat_shared.dat")
    |                      |                      |
    | map(...)             | map(...)             | map(...)
    v                      v                      v
MappedByteBuffer <------ Memory Mapping ------> MappedByteBuffer
    |                      |                      |
    | write slot (PID=1)   | write slot (PID=2)   | write slot (PID=3)
    |                      |                      |
    +-------> Shared Memory Slots (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå) <------+
```

---

## üîπ Shared Memory Layout (`REGION_SIZE = 128`)

‡πÑ‡∏ü‡∏•‡πå `heartbeat_shared.dat` ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô **slot** (128 byte ‡∏ï‡πà‡∏≠ slot):

| Slot | ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£ | Offset ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô | ‡∏ä‡πà‡∏ß‡∏á byte |
| ---- | ---------- | --------------- | --------- |
| 0    | Boss info  | 0               | 0‚Äì127     |
| 1    | PID 1      | 128             | 128‚Äì255   |
| 2    | PID 2      | 256             | 256‚Äì383   |
| 3    | PID 3      | 384             | 384‚Äì511   |

---

## üîπ ‡∏ó‡∏≥‡πÑ‡∏°‡∏°‡∏±‡∏ô‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Å

1. **‡∏ó‡∏∏‡∏Å process ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô** ‚Üí ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
2. **`RandomAccessFile` + `FileChannel.map`** ‚Üí ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô memory ‡∏ó‡∏µ‡πà map ‡πÄ‡∏Ç‡πâ‡∏≤ address space ‡∏Ç‡∏≠‡∏á process ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
3. **‡πÅ‡∏ï‡πà‡∏•‡∏∞ process ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ slot ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á** (`pid * REGION_SIZE`) ‚Üí ‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
4. **‡∏ó‡∏∏‡∏Å process ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô slot ‡∏Ç‡∏≠‡∏á process ‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ** ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô heartbeat monitor

---

üìå ‡∏û‡∏π‡∏î‡∏á‡πà‡∏≤‡∏¢ ‡πÜ

* `RandomAccessFile` = ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå
* `FileChannel` = ‡∏ó‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå
* `MappedByteBuffer` = ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© memory ‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å process ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
* `Shared Slots` = ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞ process

------------------------------------------------------------------------------------------------------------------


‡∏ó‡∏≥‡πÑ‡∏°‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ `offset = otherPid * REGION_SIZE` ‡πÅ‡∏•‡∏∞ process ‡∏ñ‡∏∂‡∏á‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ **‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡πÉ‡∏ô shared memory**

---

## üîπ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á shared memory

* ‡πÑ‡∏ü‡∏•‡πå `heartbeat_shared.dat` ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô **slot**
* ‡πÅ‡∏ï‡πà‡∏•‡∏∞ process ‡∏à‡∏∞‡∏°‡∏µ slot ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏ô memory file)
* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ slot = `REGION_SIZE` (‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô 128 byte)
* ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô memory = `slot index * REGION_SIZE`

---

## üîπ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤ `NUM_PROCESSES = 3`

* `REGION_SIZE = 128`
* ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ layout ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå `heartbeat_shared.dat`:

| Process | Offset ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô | ‡πÉ‡∏ä‡πâ memory (byte) |
| ------- | --------------- | ----------------- |
| PID 1   | `1 * 128 = 128` | 128‚Äì255           |
| PID 2   | `2 * 128 = 256` | 256‚Äì383           |
| PID 3   | `3 * 128 = 384` | 384‚Äì511           |

(*‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà index 0 ‡∏°‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö boss election*)

---

## üîπ ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á heartbeat

* `HeartbeatSender` ‡∏Ç‡∏≠‡∏á process `pid` ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á **slot ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á**:

  ```java
  int offset = pid * REGION_SIZE;
  ```

  ‡πÄ‡∏ä‡πà‡∏ô PID=2 ‚Üí `offset = 2*128 = 256` ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô heartbeat ‡∏•‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà byte 256‚Äì383

---

## üîπ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ü‡∏±‡∏á heartbeat

* `HeartbeatListener` ‡∏Ç‡∏≠‡∏á PID=1 ‡∏à‡∏∞‡∏ß‡∏ô‡∏î‡∏π‡∏ó‡∏∏‡∏Å process (2..N) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì offset:

  ```java
  int offset = otherPid * REGION_SIZE;
  ```

  ‡∏ñ‡πâ‡∏≤ otherPid=2 ‚Üí ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà byte 256‚Äì383
  ‡∏ñ‡πâ‡∏≤ otherPid=3 ‚Üí ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà byte 384‚Äì511

---

## üîπ ‡∏ó‡∏≥‡πÑ‡∏° process ‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤ slot ‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô?

‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î **‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô** ‡πÑ‡∏ß‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô:

1. ‡∏ó‡∏∏‡∏Å process ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (`heartbeat_shared.dat`)
2. ‡∏Ç‡∏ô‡∏≤‡∏î slot ‡∏ï‡πà‡∏≠ process ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (`REGION_SIZE`)
3. index ‡∏Ç‡∏≠‡∏á slot = `pid`

‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏Ñ‡πà‡∏£‡∏π‡πâ `pid` ‚Üí ‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤ slot ‡∏Ç‡∏≠‡∏á process ‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡πÉ‡∏ô memory

---

üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô ‡πÜ

* `offset = pid * REGION_SIZE` = ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
* ‡∏ó‡∏∏‡∏Å process ‡∏£‡∏π‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ ‚Üí ‡πÄ‡∏•‡∏¢‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô
* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô shared memory ‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö

---

‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ó‡∏≥ **‡∏†‡∏≤‡∏û diagram ‡∏Ç‡∏≠‡∏á memory layout (slot ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏° PID)** ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å

